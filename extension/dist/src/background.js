const f="http://localhost:3001",b="00000000-0000-0000-0000-000000000000",g=chrome.runtime.getURL("icon-128.png");function n(e,t){chrome.runtime.sendMessage({action:"backgroundCaptureToast",level:e,message:t},()=>{chrome.runtime.lastError})}function u(e){return e?!(e.startsWith("chrome://")||e.startsWith("edge://")||e.startsWith("about:")||e.startsWith("chrome-extension://")):!1}function w(e){return e?e.startsWith("http://")||e.startsWith("https://"):!1}async function y(){const e=await chrome.windows.getAll({populate:!0,windowTypes:["normal"]});if(!e.length)return null;const t=e.find(r=>r.focused)||e[0],a=t.tabs?.find(r=>r.active&&typeof r.id=="number"&&u(r.url))||t.tabs?.find(r=>typeof r.id=="number"&&u(r.url))||e.flatMap(r=>r.tabs||[]).find(r=>typeof r.id=="number"&&u(r.url));return typeof a?.id=="number"?a.id:null}function s(e){y().then(t=>{t!=null&&chrome.tabs.sendMessage(t,{action:"showPageToast",message:e},()=>{chrome.runtime.lastError})}).catch(()=>{})}chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"recall-page",title:"Recall This Page",contexts:["all"]})});chrome.contextMenus.onClicked.addListener((e,t)=>{e.menuItemId==="recall-page"&&t?.id&&d()});chrome.commands.onCommand.addListener(e=>{e==="capture-memory"&&d()});async function m(e){return await(await fetch(e)).blob()}async function h(e){try{const t=new FormData;t.append("screenshot",e,"screenshot.png"),t.append("userId",b);const a=await fetch(`${f}/process-screenshot`,{method:"POST",body:t});if(a.ok)i("Memory Captured!","AI is indexing your discovery..."),n("success","Memory Captured! AI is indexing your discovery..."),s("Memory captured successfully.");else{const r=await a.json();i("Upload Failed",r.error||"Server error"),n("error",r.error||"Upload failed"),s(r.error||"Upload failed")}}catch(t){console.error(t),i("Error","Could not connect to Recall.me server"),n("error","Could not connect to Recall.me server"),s("Could not connect to Recall.me server")}}async function d(){try{n("info","Capturing memory...");const e=await chrome.windows.getAll({populate:!0,windowTypes:["normal"]}),t=e.find(o=>o.focused)||e[0],a=t?.tabs?.find(o=>o.active),r=t?.id;if(r==null||!a){const o="No active browser tab to capture";i("Error",o),n("error",o),s(o);return}if(!w(a.url)){const o="Open a normal website (http/https) and try Ctrl+Shift+S again";i("Capture Not Allowed",o),n("error",o),s(o);return}chrome.tabs.captureVisibleTab(r,{format:"png"},async o=>{if(chrome.runtime.lastError){const c=chrome.runtime.lastError.message||"Failed to capture screen",l=c.includes("Either the '<all_urls>' or 'activeTab' permission is required.")?"Capture blocked on this tab. Switch to a normal website tab and try again.":c;console.error("Capture error:",c),i("Error",l),n("error",l),s(l);return}if(!o){i("Error","Failed to capture screen"),n("error","Failed to capture screen"),s("Failed to capture screen");return}const p=await m(o);await h(p)})}catch(e){console.error(e),i("Error","Screenshot capture failed"),n("error","Screenshot capture failed"),s("Screenshot capture failed")}}function i(e,t){chrome.notifications.create({type:"basic",iconUrl:g,title:e,message:t,priority:2,requireInteraction:!0})}chrome.runtime.onMessage.addListener((e,t,a)=>{if(e.action==="captureVisibleTab")return chrome.tabs.captureVisibleTab(null,{format:"png"},r=>{if(chrome.runtime.lastError){a({dataUrl:null,error:chrome.runtime.lastError.message});return}a({dataUrl:r})}),!0;if(e.action==="hotkeyCapture")return d(),a({success:!0}),!0;if(e.action==="uploadPastedImage"&&e.imageData)return m(e.imageData).then(r=>{h(r)}).catch(r=>{console.error("Blob conversion error:",r),i("Error","Failed to process pasted image")}),a({success:!0}),!0});
